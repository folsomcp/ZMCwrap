# ZMCwrap

ZMCwrap is a tool for estimating stellar parameters using MCMC and spectrum synthesis.  It is built as a Python wrapper around the Zeeman spectrum synthesis code.

This requires the `emcee` package to run the MCMC sampler (see [emcee's docs](https://emcee.readthedocs.io/en/stable/)).  The package uses `numpy`, `scipy`, and `matplotlib`.  This also requires a copy of the Zeeman spectrum synthesis code to run, but could be adapted to other codes.

If you use this software in your research, please cite Folsom et al. (in prep.)

## Usage

There are a few useful tools provided by this package.  Several executable scripts are in the root folder, while the main code is in the zmcwrap folder.

The `runzmc.py` file provides a example of setting up and executing an MCMC modelling run.  In this example the observation file is read from `observed.dat`.  The observation file should be a text file with columns of wavelength, flux, and uncertainties on the flux; or columns of wavelength, flux, three columns that are skipped (e.g. polarimetric information) and uncertainties on the flux.

Running this function requires having a version of Zeeman set up, because functions used by `runzmc.py` will attempt to run Zeeman.  Some important information must be set up with Zeeman.  Particularly the line list and any desired oscillator strength corrections must be set up as usual.  The wavelength range for the synthetic spectrum must also be set in Zeeman, and this should be somewhat wider than the wavelength range chosen for fitting in `runzmc.py` (with the `wlRanges` list).  Setting the synthetic spectrum wavelength range somewhat wider to allows for Doppler shifting by a radial velocity.  

The `continuezmc.py` file provides an example of continuing an existing MCMC chain, and adding more samples to the end of the chain.  In this example, the script uses the `chain.dat` file, generated by running `runzmc.py` first.

The `plotChain.py` script plots parameter values as a function of step in the chain.  Then it prints out the median values, as well as uncertainties from percentiles corresponding to a 1 sigma and 3 sigma confidence levels.  Then it generates a corner plot of the parameter distributions.  When running this script it is important to specify the number of burn-in steps in the chain.  This is done by running the script with the `-b` flag, like: `python plotChain.py -b 300`.  You can run the script with the `-h` flag (`python plotChain.py -h`) for more help information.

The `plotChainAltLabels.py` script behaves like `plotChain.py` although it uses alternative shorter labels for the parameters in the plots.

The `plotSpecSamp.py` script can be used if you have run the `zmcwrap.calcSynSpecSamples` function (with examples of that in `runzmc.py` or `continuezmc.py`).  This will plot the observation, best fit (median) model, and the set of individual sample models.  You can run the script with `python plotSpecSamp.py -h` for some help information.  By default the script will try to read an observation from `observed.dat` or it can be specified with `-o`.  The default best fit model is `outSpeci.dat` or it can be specified with `-b`.  The default set of sample spectra is `outSpecSamples.dat` or it can be specified with `-s`.

The `plotSpecSampLines.py` script is similar to `plotSpecSamp.py`, but it also can plot a line list.  This uses the SpecpolFlow package (see [SpecpolFlow's docs](https://folsomcp.github.io/specpolFlow/index.html)) to plot the line list.  The line list can be specified with `-l`, use `-h` for more information.

## Main Functions

The ZMCwrap package provide a few main functions.  These are used in the executable scripts mentioned above.  You can just use or modify the executable scripts discussed above, or you can use these functions in your own scripts.  `runMCMC` runs the main MCMC code. `continueMCMC` adds more samples to an existing MCMC chain.  `readChain` reads a chain file for further processing.  `chainPlot` makes plots parameters as a function of step in the chain, useful for checking convergence.  `cornerPlotLight` generates corner plots of the parameter distributions, and tries to do so in a relatively efficient fashion for large numbers of parameters.  (See the `corner` package, a companion to `emcee`, as less efficient but more elaborate alternative to `cornerPlotLight`).  `calcSynSpecSamples` calculates a set of synthetic spectra corresponding to the last n steps in the chain, saving them to a file. `readSpecSamples` reads in the file of sample spectra (returning them as a numpy array).  

## Adapting

While ZMCwrap is designed to run with the Zeeman spectrum synthesis code, it can be modified to use other spectrum synthesis codes to generate model spectra.  Doing this requires replacing the current `runSpecSynth` function in the `zmcwrap/wrapper_zeeman.py` file.  This function needs to take lists of free parameters and free parameter IDs, and a dict of fixed parameters, and return lists with the wavelength and continuum normalized flux for the model spectrum (other functions will interpolate that onto the observed spectrum).  Other functions in that file can be used a an example of how to write input files used by the spectrum synthesis code.  

## Acknowledgements

This project was supported by funding from the European Union's Horizon Europe research and innovation programme under grant agreement No. 101079231 (EXOHOST), and from the United Kingdom Research and Innovation (UKRI) Horizon Europe Guarantee Scheme (grant number 10051045). 